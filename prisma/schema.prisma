generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===================================
// ENUMS
// ===================================

enum UserRole {
  SUPER_ADMIN
  MANAGER
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SchoolType {
  LIGHT_VEHICLE
  MOTORCYCLE
  HEAVY_VEHICLE
  COMBINED
  ALL_CATEGORIES
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

enum PaymentMethod {
  CASH
  CARD
  ONLINE
}

enum LessonTypeName {
  THEORY
  PRACTICAL
  ROAD_TEST
  PARKING_TEST
  ASSESSMENT_TEST
}


// ===================================
// USER (BASE ENTITY)
// ===================================

model User {
  id         String     @id @default(uuid())
  firstName  String     @map("first_name") @db.VarChar(30)
  lastName   String     @map("last_name") @db.VarChar(30)
  email      String?    @unique @db.VarChar(100)
  emiratesId String?    @unique @map("emirates_id") @db.VarChar(20)
  password   String
  phone      String     @unique @db.VarChar(20)
  role       UserRole
  status     UserStatus @default(ACTIVE)

  schools    UserSchool[]
  Instructor Instructor?

  // If user is a student
  studentAppointments Appointment[] @relation("StudentAppointments")

  // If user is an instructor
  instructorAppointments Appointment[] @relation("InstructorAppointments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ===================================
// SCHOOL
// ===================================

model School {
  id                 String       @id @default(uuid())
  name               String
  tradeLicense       String       @unique @map("trade_license")
  tradeLicenseExpiry DateTime     @map("trade_license_expiry")
  schoolType         SchoolType   @default(ALL_CATEGORIES) @map("school_type")
  address            String
  city               String
  country            String
  status             SchoolStatus @default(ACTIVE)
  phone              String

  users              UserSchool[]
  
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  appointments Appointment[]

  @@map("schools")
}

// ===================================
// INSTRUCTOR
// ===================================

model Instructor {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  licenseNo         String   @map("license_no")
  licenseExpiryDate DateTime @map("license_expiry_date")
  experienceYears   Int      @map("experience_years")

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("instructors")
}

// ===================================
// USER â†” SCHOOL (ADMINS / STAFF)
// ===================================

model UserSchool {
  id       String @id @default(uuid())
  userId   String @map("user_id")
  schoolId String @map("school_id")

  user   User   @relation(fields: [userId], references: [id])
  school School @relation(fields: [schoolId], references: [id])

  assignedAt DateTime @default(now()) @map("assigned_at")

  @@unique([userId, schoolId])
  @@map("user_schools")
}

// ===================================
// APPOINTMENT (DRIVING CLASS)
// ===================================

model Appointment {
  id       String @id @default(uuid())
  schoolId String @map("school_id")

  lessonType LessonTypeName @map("lesson_type")


  // Student relation
  student   User   @relation("StudentAppointments", fields: [studentId], references: [id])
  studentId String @map("student_id")

  // Instructor relation
  instructor   User   @relation("InstructorAppointments", fields: [instructorId], references: [id])
  instructorId String @map("instructor_id")

  school School @relation(fields: [schoolId], references: [id])

  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  durationMin Int      @map("duration_min")

  hourlyRate  Float @map("hourly_rate")
  totalAmount Float @map("total_amount")

  status        AppointmentStatus @default(SCHEDULED)
  paymentStatus PaymentStatus     @default(UNPAID) @map("payment_status")
  payment       Payment?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([schoolId])
  @@index([studentId])
  @@index([instructorId])
  @@map("appointments")
}

// ===================================
// PAYMENT
// ===================================

model Payment {
  id            String @id @default(uuid())
  appointmentId String @unique @map("appointment_id")

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  amount      Float
  method      PaymentMethod
  paidAt      DateTime      @map("paid_at")
  referenceNo String?       @map("reference_no")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("payments")
}
